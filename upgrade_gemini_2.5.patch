*** Begin Patch
*** Add File: index.js
+// index.js (upgraded for gemini-2.5-flash, safer API usage, better logging)
+import express from "express";
+import axios from "axios";
+import bodyParser from "body-parser";
+import dotenv from "dotenv";
+
+dotenv.config();
+
+const PORT = process.env.PORT || 10000;
+const app = express();
+app.use(bodyParser.json({ limit: "1mb" }));
+
+// Env sanity check at startup
+const REQUIRED_ENVS = [
+  "LINE_CHANNEL_ACCESS_TOKEN",
+  "LINE_CHANNEL_SECRET",
+  "GOOGLE_API_KEY",
+  "GOOGLE_AI_MODEL"
+];
+for (const e of REQUIRED_ENVS) {
+  if (!process.env[e]) {
+    console.warn(`[WARN] env ${e} is not set — set it in Render / .env for production.`);
+  }
+}
+
+// helper: call Google Generative API (Gemini)
+async function askGoogleAI(prompt, options = {}) {
+  const model = process.env.GOOGLE_AI_MODEL || "gemini-2.5-flash";
+  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateMessage`;
+
+  try {
+    const payload = {
+      // Using the "messages" style payload to be future-proof.
+      // The actual API accepts several shapes; this one is concise and widely compatible.
+      messages: [
+        { author: "user", content: { text: prompt } }
+      ],
+      maxOutputTokens: options.maxOutputTokens || 800
+    };
+
+    const resp = await axios.post(url, payload, {
+      headers: {
+        Authorization: `Bearer ${process.env.GOOGLE_API_KEY}`,
+        "Content-Type": "application/json"
+      },
+      timeout: 15000
+    });
+
+    // defensive: try to grab text in several possible fields
+    if (resp?.data) {
+      // Newer API returns 'candidates' or 'output' shapes; this reads common ones.
+      if (resp.data?.candidates && resp.data.candidates[0]?.content) {
+        return resp.data.candidates[0].content.trim();
+      }
+      if (resp.data?.message?.content?.text) {
+        return resp.data.message.content.text.trim();
+      }
+      // fallback to JSON stringify (short)
+      return JSON.stringify(resp.data).slice(0, 4000);
+    }
+    return "";
+  } catch (err) {
+    // surface helpful debug info
+    const status = err?.response?.status;
+    const body = err?.response?.data;
+    console.error("[Google AI] request failed", { status, body, message: err.message });
+    throw err;
+  }
+}
+
+// helper: reply via LINE reply API
+async function replyLine(replyToken, text) {
+  const token = process.env.LINE_CHANNEL_ACCESS_TOKEN;
+  if (!token) throw new Error("LINE_CHANNEL_ACCESS_TOKEN not set");
+  try {
+    await axios.post(
+      "https://api.line.me/v2/bot/message/reply",
+      {
+        replyToken,
+        messages: [{ type: "text", text }]
+      },
+      {
+        headers: {
+          Authorization: `Bearer ${token}`,
+          "Content-Type": "application/json"
+        },
+        timeout: 8000
+      }
+    );
+  } catch (err) {
+    console.error("[LINE] reply failed", err?.response?.data || err?.message);
+    throw err;
+  }
+}
+
+// webhook endpoint
+app.post("/webhook", async (req, res) => {
+  res.status(200).send("ok");
+  const body = req.body;
+  try {
+    if (!body || !body.events) return;
+    for (const ev of body.events) {
+      try {
+        // handle only message events for now
+        if (ev.type === "message" && ev.message?.type === "text") {
+          const userText = ev.message.text;
+          console.log("[EVENT] userText:", userText);
+
+          // customize prompt or pipeline here; simple pass-through for PoC
+          const prompt = `你是一位中文交易教練，使用者說：${userText}`;
+          const aiReply = await askGoogleAI(prompt, { maxOutputTokens: 500 });
+
+          const replyText = aiReply || "抱歉，我目前沒回答到，請稍微重述一下。";
+          await replyLine(ev.replyToken, replyText);
+        } else {
+          console.log("[EVENT] ignored event type:", ev.type);
+        }
+      } catch (innerErr) {
+        console.error("Error processing single event:", innerErr?.message || innerErr);
+        // try to notify user of error in short form (best effort)
+        try { await replyLine(ev.replyToken, "系統發生錯誤，請稍後再試。"); } catch (e) {}
+      }
+    }
+  } catch (err) {
+    console.error("Error processing webhook:", err?.message || err);
+  }
+});
+
+app.get("/", (req, res) => {
+  res.send("Line bot upgraded — gemini-2.5-flash PoC");
+});
+
+app.listen(PORT, () => {
+  console.log(`LINE Bot webhook listening on port ${PORT}`);
+});
+
*** End Patch
*** Begin Patch
*** Update File: package.json
@@
 {
-  "name": "line-deepseek-bot",
-  "version": "1.0.0",
-  "main": "index.js",
-  "license": "UNLICENSED",
-  "scripts": {
-    "start": "node index.js"
-  },
-  "dependencies": {
-    "axios": "^1.3.0",
-    "express": "^4.17.1",
-    "body-parser": "^1.19.0",
-    "dotenv": "^16.0.0"
-  }
+  "name": "line-deepseek-bot",
+  "version": "1.1.0",
+  "type": "module",
+  "main": "index.js",
+  "license": "UNLICENSED",
+  "scripts": {
+    "start": "node index.js",
+    "start:dev": "nodemon index.js"
+  },
+  "dependencies": {
+    "axios": "^1.5.0",
+    "express": "^4.18.2",
+    "body-parser": "^1.20.2",
+    "dotenv": "^16.3.1"
+  },
+  "devDependencies": {
+    "nodemon": "^3.0.1"
+  }
 }
*** End Patch
